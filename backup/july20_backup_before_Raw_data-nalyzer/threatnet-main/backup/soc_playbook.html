<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise SOC Playbook & Incident Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Mode Colors */
            --primary-color: #1e3c72; /* Dark Blue */
            --secondary-color: #2a5298; /* Lighter Blue for gradients, borders */
            --accent-color: #007bff; /* General interactive elements */
            --danger-color: #dc3545;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;

            --bg-body-light: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); /* Softer, professional light background */
            --bg-card-light: #ffffff;
            --text-primary-light: #333333;
            --text-secondary-light: #666666;
            --border-light: #dbe4eb;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --input-bg-light: #f8f9fa;
            --step-bg-light: #f0f4f7;
            --modal-backdrop-light: rgba(0, 0, 0, 0.6);
            --modal-bg-light: #ffffff;
        }

        body.dark-mode {
            /* Dark Mode Colors */
            --primary-color: #4a90e2; /* Softer blue for dark mode header */
            --secondary-color: #3467a8; /* Darker blue for dark mode gradients */
            --accent-color: #66b3ff; /* Lighter blue for interactive elements */
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --info-color: #3498db;
            --warning-color: #f1c40f;

            --bg-body-dark: #2c3e50; /* Deep blue-grey */
            --bg-card-dark: #34495e; /* Slightly lighter blue-grey for cards */
            --text-primary-dark: #ecf0f1; /* Off-white */
            --text-secondary-dark: #bdc3c7; /* Lighter grey */
            --border-dark: #4a6a84;
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --input-bg-dark: #212b36;
            --step-bg-dark: #2a3847;
            --modal-backdrop-dark: rgba(0, 0, 0, 0.8);
            --modal-bg-dark: #34495e;
        }

        /* --- Global Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-body-light);
            min-height: 100vh;
            color: var(--text-primary-light);
            transition: background 0.5s ease, color 0.5s ease;
            display: flex;
            flex-direction: column; /* This is correct for header-content-footer layout */
        }

        body.dark-mode {
            background: var(--bg-body-dark);
            color: var(--text-primary-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allows container to take up available space between header and footer */
            width: 100%; /* Ensure it spans full width for centering */
        }

        /* --- Header --- */
        .app-header {
            background: var(--bg-card-light);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-light);
            box-shadow: 0 4px 15px var(--shadow-light);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: background 0.5s ease, box-shadow 0.5s ease;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        body.dark-mode .app-header {
            background: var(--bg-card-dark);
            border-bottom: 1px solid var(--border-dark);
            box-shadow: 0 4px 15px var(--shadow-dark);
        }

        .app-header-left h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-header-left p {
            color: var(--text-secondary-light);
            font-size: 0.95rem;
        }
        body.dark-mode .app-header-left p {
            color: var(--text-secondary-dark);
        }

        .theme-toggle {
            background: var(--input-bg-light);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-light);
            font-size: 1.3rem;
            color: var(--text-primary-light);
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .theme-toggle {
            background: var(--input-bg-dark);
            border: 1px solid var(--border-dark);
            box-shadow: 0 2px 8px var(--shadow-dark);
            color: var(--text-primary-dark);
        }
        .theme-toggle:hover {
            transform: scale(1.05);
        }

        /* --- Main Navigation --- */
        .main-nav {
            display: flex;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
            justify-content: center; /* Center align nav items */
        }

        .nav-btn {
            background: var(--bg-card-light);
            border: 1px solid var(--border-light);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-light);
            color: var(--text-primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .nav-btn {
            background: var(--bg-card-dark);
            border: 1px solid var(--border-dark);
            box-shadow: 0 2px 8px var(--shadow-dark);
            color: var(--text-primary-dark);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-light);
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        body.dark-mode .nav-btn:hover {
            box-shadow: 0 4px 12px var(--shadow-dark);
            background: var(--primary-color); /* Use dark mode primary */
            color: var(--text-primary-dark); /* Keep text light in dark mode hover */
            border-color: var(--primary-color);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.4);
        }
        body.dark-mode .nav-btn.active {
            border: 1px solid var(--primary-color);
        }

        /* --- Content Sections --- */
        .content-section {
            display: none;
            background: var(--bg-card-light);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px var(--shadow-light);
            border: 1px solid var(--border-light);
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }
        body.dark-mode .content-section {
            background: var(--bg-card-dark);
            box-shadow: 0 8px 25px var(--shadow-dark);
            border: 1px solid var(--border-dark);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-section h2 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 25px;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary-light);
        }
        body.dark-mode .form-group label {
            color: var(--text-primary-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--input-bg-light);
            color: var(--text-primary-light);
        }
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: var(--input-bg-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-primary-dark);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.15);
        }
        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group select:focus,
        body.dark-mode .form-group textarea:focus {
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.3);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(30, 60, 114, 0.2);
        }

        .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); }
        .btn-secondary:hover { box-shadow: 0 4px 10px rgba(108, 117, 125, 0.2); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #c82333); }
        .btn-danger:hover { box-shadow: 0 4px 10px rgba(220, 53, 69, 0.2); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #20c997); }
        .btn-success:hover { box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2); }
        .btn-info { background: linear-gradient(135deg, var(--info-color), #138496); }
        .btn-info:hover { box-shadow: 0 4px 10px rgba(23, 162, 184, 0.2); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* --- Grids (Playbooks, Instances, Stats) --- */
        .playbook-grid, .instance-grid, .stats-grid {
            display: grid;
            gap: 25px;
        }
        .playbook-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
        .instance-grid { grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
        .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;}

        /* --- Cards (Playbook, Instance, Stat) --- */
        .playbook-card, .instance-card, .stat-card {
            background: var(--bg-card-light);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px var(--shadow-light);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary-light);
        }
        body.dark-mode .playbook-card, body.dark-mode .instance-card, body.dark-mode .stat-card {
            background: var(--bg-card-dark);
            box-shadow: 0 4px 12px var(--shadow-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-primary-dark);
        }

        .playbook-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        .playbook-card:hover, .instance-card:hover, .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow-light);
        }
        body.dark-mode .playbook-card:hover, body.dark-mode .instance-card:hover, body.dark-mode .stat-card:hover {
            box-shadow: 0 8px 20px var(--shadow-dark);
        }

        .playbook-title, .instance-card h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .alert-type {
            background: linear-gradient(135deg, var(--info-color), #138496);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 5px;
        }

        .playbook-meta, .instance-card div[style*="grid-template-columns"] {
            font-size: 0.9rem;
            color: var(--text-secondary-light);
            margin-bottom: 15px;
        }
        body.dark-mode .playbook-meta, body.dark-mode .instance-card div[style*="grid-template-columns"] {
            color: var(--text-secondary-dark);
        }

        .step-item {
            background: var(--step-bg-light);
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 5px;
            border-left: 3px solid var(--secondary-color);
            font-size: 0.9rem;
            color: var(--text-primary-light);
        }
        body.dark-mode .step-item {
            background: var(--step-bg-dark);
            color: var(--text-primary-dark);
        }

        .instance-card::before {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); /* Default for all */
        }
        .instance-card.status-new::before { background: linear-gradient(135deg, var(--warning-color), #e0a800); }
        .instance-card.status-in-progress::before { background: linear-gradient(135deg, var(--info-color), #138496); }
        .instance-card.status-escalated::before { background: linear-gradient(135deg, var(--danger-color), #c82333); }
        .instance-card.status-resolved::before { background: linear-gradient(135deg, var(--success-color), #20c997); }
        .instance-card.status-closed::before { background: linear-gradient(135deg, #495057, #343a40); } /* Grey for closed */

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .status-new { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #d1ecf1; color: #0c5460; }
        .status-escalated { background: #f8d7da; color: #721c24; }
        .status-resolved { background: #d4edda; color: #155724; }
        .status-closed { background: #e2e6ea; color: #383d41; }
        body.dark-mode .status-new { background: #5a4b00; color: #ffeb3b; }
        body.dark-mode .status-in-progress { background: #0a4c5a; color: #81d4fa; }
        body.dark-mode .status-escalated { background: #7b000a; color: #ff7083; }
        body.dark-mode .status-resolved { background: #1a4f21; color: #a5d6a7; }
        body.dark-mode .status-closed { background: #495057; color: #d1d9e0; }

        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        .stat-label {
            color: var(--text-secondary-light);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        body.dark-mode .stat-label {
            color: var(--text-secondary-dark);
        }

        /* --- Modals (General) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place even if content scrolls */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: var(--modal-backdrop-light);
            backdrop-filter: blur(5px);
            overflow: auto; /* Enable scroll if needed */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            transition: background-color 0.5s ease;
        }
        body.dark-mode .modal {
            background-color: var(--modal-backdrop-dark);
        }

        .modal-content {
            background: var(--modal-bg-light);
            margin: auto; /* Centers the modal vertically and horizontally */
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px; /* Default max-width */
            max-height: 90vh; /* Max height of modal content, allows internal scrolling */
            overflow-y: auto; /* Scroll content if it exceeds max-height */
            box-shadow: 0 20px 60px var(--shadow-light);
            animation: modalSlide 0.3s ease-out;
            color: var(--text-primary-light);
            transition: background 0.5s ease, box-shadow 0.5s ease, color 0.5s ease;
            position: relative; /* Needed for z-index context */
            top: 0; /* Reset top to avoid accidental offsets */
            left: 0; /* Reset left to avoid accidental offsets */
        }
        body.dark-mode .modal-content {
            background: var(--modal-bg-dark);
            box-shadow: 0 20px 60px var(--shadow-dark);
            color: var(--text-primary-dark);
        }

        .close {
            color: var(--text-secondary-light);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            position: absolute; /* Position close button relative to modal-content */
            top: 15px;
            right: 25px;
        }

        .close:hover {
            color: var(--text-primary-light);
        }
        body.dark-mode .close {
            color: var(--text-secondary-dark);
        }
        body.dark-mode .close:hover {
            color: var(--text-primary-dark);
        }

        .step-builder {
            border: 1px dashed var(--border-light);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: var(--step-bg-light);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .step-builder {
            background: var(--step-bg-dark);
            border-color: var(--border-dark);
        }


        .step-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .step-input-group input {
            flex: 1;
        }

        .step-list {
            list-style: none;
            padding: 0;
        }

        .step-list li {
            background: var(--bg-card-light);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary-light);
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .step-list li {
            background: var(--bg-card-dark);
            color: var(--text-primary-dark);
        }

        .step-list li button {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .export-section, .import-section {
            margin-top: 30px;
            padding: 25px;
            background: var(--bg-card-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 15px var(--shadow-light);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .export-section, body.dark-mode .import-section {
            background: var(--bg-card-dark);
            box-shadow: 0 4px 15px var(--shadow-dark);
            border: 1px solid var(--border-dark);
        }


        .export-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* --- Custom Detailed View Modal --- */
        #detailsModal .modal-content {
            max-width: 1000px; /* Wider for details */
            max-height: 90vh;
        }
        #detailsModal h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        #detailsModal p {
            color: var(--text-secondary-light);
            margin-bottom: 10px;
        }
        body.dark-mode #detailsModal p {
            color: var(--text-secondary-dark);
        }
        #detailsModal strong {
            color: var(--text-primary-light);
        }
        body.dark-mode #detailsModal strong {
            color: var(--text-primary-dark);
        }
        #detailsModal .detail-section {
            background: var(--input-bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-light);
            color: var(--text-primary-light);
        }
        body.dark-mode #detailsModal .detail-section {
            background: var(--input-bg-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-primary-dark);
        }
        #detailsModal .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        #detailsModal .detail-grid > div {
            padding: 5px 0;
            border-bottom: 1px dashed var(--border-light);
        }
        body.dark-mode #detailsModal .detail-grid > div {
            border-bottom: 1px dashed var(--border-dark);
        }
        #detailsModal ol {
            padding-left: 20px;
            margin-top: 10px;
        }
        #detailsModal ol li {
            margin-bottom: 8px;
            color: var(--text-primary-light);
        }
        body.dark-mode #detailsModal ol li {
            color: var(--text-primary-dark);
        }

        /* --- Search Bar --- */
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping for responsiveness */
        }
        .search-bar input, .search-bar select {
            flex: 1; /* Allow input/select to grow */
            min-width: 180px; /* Minimum width before wrapping */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: var(--input-bg-light);
            color: var(--text-primary-light);
            transition: border-color 0.3s ease;
        }
        body.dark-mode .search-bar input, body.dark-mode .search-bar select {
            border: 1px solid var(--border-dark);
            background: var(--input-bg-dark);
            color: var(--text-primary-dark);
        }
        .search-bar input:focus, .search-bar select:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        .search-bar button {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            border: none;
            transition: opacity 0.3s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .search-bar button:hover {
            opacity: 0.9;
        }

        /* --- Footer --- */
        .app-footer {
            margin-top: 50px;
            padding: 20px;
            background: var(--bg-card-light);
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -2px 10px var(--shadow-light);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary-light);
            transition: background 0.5s ease, box-shadow 0.5s ease;
            flex-shrink: 0; /* Prevent footer from shrinking */
        }
        body.dark-mode .app-footer {
            background: var(--bg-card-dark);
            border-top: 1px solid var(--border-dark);
            box-shadow: 0 -2px 10px var(--shadow-dark);
            color: var(--text-secondary-dark);
        }
        .app-footer a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 5px;
            transition: color 0.3s ease;
        }
        .app-footer a:hover {
            text-decoration: underline;
            color: var(--secondary-color);
        }

        /* --- Loading Overlay --- */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 15px;
            transition: opacity 0.3s ease;
        }

        .loading-overlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Audit Trail Specific Styles --- */
        #auditTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-primary-light);
        }
        body.dark-mode #auditTable {
            color: var(--text-primary-dark);
        }

        #auditTable th, #auditTable td {
            border: 1px solid var(--border-light);
            padding: 12px 15px;
            text-align: left;
        }
        body.dark-mode #auditTable th, body.dark-mode #auditTable td {
            border: 1px solid var(--border-dark);
        }

        #auditTable th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        body.dark-mode #auditTable th {
            background-color: var(--secondary-color);
            color: var(--text-primary-dark);
        }

        #auditTable tr:nth-child(even) {
            background-color: var(--input-bg-light);
        }
        body.dark-mode #auditTable tr:nth-child(even) {
            background-color: var(--input-bg-dark);
        }

        #auditTable tr:hover {
            background-color: var(--step-bg-light);
        }
        body.dark-mode #auditTable tr:hover {
            background-color: var(--step-bg-dark);
        }

        #auditTable td span.action-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 5px;
            white-space: nowrap; /* Keep badge text on one line */
        }
        .action-badge.created { background: #d4edda; color: #155724; } /* Green */
        .action-badge.updated { background: #cce5ff; color: #004085; } /* Blue */
        .action-badge.deleted { background: #f8d7da; color: #721c24; } /* Red */
        .action-badge.generated { background: #fff3cd; color: #856404; } /* Yellow */
        .action-badge.imported { background: #bee5eb; color: #005662; } /* Cyan */
        .action-badge.exported { background: #e0e9ed; color: #36454F; } /* Grey */
        .action-badge.theme { background: #e3d2ff; color: #5a008c; } /* Purple */

        body.dark-mode .action-badge.created { background: #1a4f21; color: #a5d6a7; }
        body.dark-mode .action-badge.updated { background: #003366; color: #99ccff; }
        body.dark-mode .action-badge.deleted { background: #7b000a; color: #ff7083; }
        body.dark-mode .action-badge.generated { background: #5a4b00; color: #ffeb3b; }
        body.dark-mode .action-badge.imported { background: #0a4c5a; color: #81d4fa; }
        body.dark-mode .action-badge.exported { background: #34495e; color: #bdc3c7; }
        body.dark-mode .action-badge.theme { background: #4a007f; color: #cc99ff; }


        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 992px) {
            .app-header { padding: 15px 20px; }
            .app-header-left h1 { font-size: 1.8rem; }
            .app-header-left p { font-size: 0.85rem; }
            .main-nav { gap: 8px; margin: 20px 0; }
            .nav-btn { padding: 10px 15px; font-size: 0.9rem; }
            .content-section { padding: 20px; }
            .content-section h2 { font-size: 1.6rem; margin-bottom: 20px; }
            .playbook-grid, .instance-grid, .stats-grid { gap: 20px; }
            .stat-number { font-size: 2.2rem; }
            .stat-label { font-size: 0.8rem; }
            .modal-content { margin: 3% auto; }
            #detailsModal .modal-content { max-width: 95%; }
            .search-bar input, .search-bar select { min-width: unset; }
            .search-bar { flex-direction: column; align-items: stretch;}
            .search-bar button { width: 100%;}
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .app-header { flex-direction: column; text-align: center; }
            .app-header-right { width: 100%; text-align: center; }
            .theme-toggle { margin: 10px auto 0; }
            .playbook-grid, .instance-grid, .stats-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 5% auto; padding: 15px; }
            .close { top: 10px; right: 15px; font-size: 24px; }
            .btn { padding: 8px 15px; font-size: 0.9rem; gap: 5px; }
            .playbook-actions .btn { width: calc(50% - 4px); margin-right: 0; margin-bottom: 8px;} /* Stack buttons 2 per row */
            .playbook-actions .btn:nth-child(even) { margin-left: 8px;} /* Space between stacked buttons */
            .playbook-actions .btn:last-child { margin-bottom: 0;}
            .instance-card .playbook-actions .btn {width: auto;} /* Allow buttons to wrap naturally */
            #auditTable th, #auditTable td { padding: 8px 10px; font-size: 0.85em; }
        }

        @media (max-width: 480px) {
            .app-header-left h1 { font-size: 1.5rem; }
            .app-header-left p { font-size: 0.8rem; }
            .nav-btn { padding: 8px 12px; font-size: 0.85rem; }
            .content-section h2 { font-size: 1.4rem; }
            .stat-number { font-size: 2rem; }
            .playbook-title, .instance-card h3 { font-size: 1.1rem; }
            .form-group label { font-size: 0.9rem; }
            .form-group input, .form-group select, .form-group textarea { font-size: 0.9rem; padding: 8px 12px;}
            .step-list li span { font-size: 0.85rem; }
            .playbook-actions .btn { width: 100%; margin-right: 0; margin-left: 0; }
        }
    </style>
</head>
<body class="light-mode">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Processing...</div>
        <p id="loadingSubtext" style="font-size: 1rem; margin-top: 10px; opacity: 0.8;">Please wait, simulating secure data transfer...</p>
    </div>

    <header class="app-header">
        <div class="app-header-left">
            <h1>SOC Playbook & Incident Manager</h1>
            <p>Enterprise-grade Security Operations Center playbook management and incident tracking system</p>
        </div>
        <div class="app-header-right">
            <div class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun"></i> </div>
        </div>
    </header>

    <div class="container">
        <nav class="main-nav">
            <button class="nav-btn active" onclick="showSection('dashboard', this)">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-btn" onclick="showSection('playbooks', this)">
                <i class="fas fa-book"></i> Playbooks
            </button>
            <button class="nav-btn" onclick="showSection('instances', this)">
                <i class="fas fa-exclamation-triangle"></i> Active Incidents
            </button>
            <button class="nav-btn" onclick="showSection('reports', this)">
                <i class="fas fa-chart-line"></i> Reports & Export
            </button>
            <button class="nav-btn" onclick="showSection('auditTrail', this)">
                <i class="fas fa-history"></i> Audit Trail
            </button>
        </nav>

        <div id="dashboard" class="content-section active">
            <h2 style="margin-bottom: 25px; color: var(--primary-color);">SOC Operations Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPlaybooks">0</div>
                    <div class="stat-label">Total Playbooks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeInstances">0</div>
                    <div class="stat-label">Active Incidents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="resolvedToday">0</div>
                    <div class="stat-label">Resolved Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="escalatedCount">0</div>
                    <div class="stat-label">Escalated Incidents</div>
                </div>
                 <div class="stat-card">
                    <div class="stat-number" id="criticalOpen">0</div>
                    <div class="stat-label">Critical Open</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 30px;">
                <div style="background: var(--bg-card-light); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); border: 1px solid var(--border-light);">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Recent Activity</h3>
                    <div id="recentActivity">
                        <p style="color: var(--text-secondary-light); font-style: italic;">No recent activity</p>
                    </div>
                </div>
                <div style="background: var(--bg-card-light); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); border: 1px solid var(--border-light);">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Quick Actions</h3>
                    <button class="btn" onclick="showSection('playbooks', document.querySelector('.nav-btn:nth-child(2)')); simulateBackendOperation('Opening playbook creation...', showCreatePlaybookModal);">
                        <i class="fas fa-plus-circle"></i> Create New Playbook
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('instances', document.querySelector('.nav-btn:nth-child(3)'))">
                        <i class="fas fa-eye"></i> View All Incidents
                    </button>
                     <button class="btn btn-info" onclick="simulateBackendOperation('Initializing new incident...', showCreateInstanceModal);">
                        <i class="fas fa-fire-alt"></i> Start New Incident
                    </button>
                </div>
            </div>
        </div>

        <div id="playbooks" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h2 style="color: var(--primary-color);">Playbook Management</h2>
                <button class="btn" id="createPlaybookBtn" onclick="simulateBackendOperation('Opening playbook creation...', showCreatePlaybookModal);">
                    <i class="fas fa-plus-circle"></i> Create New Playbook
                </button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="playbookSearch" placeholder="Search playbooks by title, type, description..." onkeyup="filterPlaybooks()">
                <button onclick="filterPlaybooks()"><i class="fas fa-search"></i> Search</button>
            </div>

            <div class="playbook-grid" id="playbookGrid">
                </div>
        </div>

        <div id="instances" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                <h2 style="color: var(--primary-color);">Active Incident Instances</h2>
                <button class="btn" onclick="simulateBackendOperation('Initializing new incident...', showCreateInstanceModal);">
                    <i class="fas fa-plus-circle"></i> Create New Incident
                </button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="instanceSearch" placeholder="Search incidents by title, analyst, playbook..." onkeyup="filterInstances()">
                <select id="statusFilter" onchange="filterInstances()" style="padding: 10px 15px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--input-bg-light); color: var(--text-primary-light);">
                    <option value="">All Statuses</option>
                    <option value="new">New</option>
                    <option value="in-progress">In Progress</option>
                    <option value="escalated">Escalated</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <button onclick="filterInstances()"><i class="fas fa-filter"></i> Filter</button>
            </div>
            
            <div class="instance-grid" id="instanceGrid">
                </div>
        </div>

        <div id="reports" class="content-section">
            <h2 style="margin-bottom: 25px; color: var(--primary-color);">Reports & Export</h2>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">Export Options</h3>
                <p style="margin-bottom: 15px; color: var(--text-secondary-light);">Generate comprehensive reports for analysis and documentation.</p>
                
                <div class="export-options">
                    <button class="btn" onclick="exportPlaybooks()">
                        <i class="fas fa-file-pdf"></i> Export All Playbooks (PDF)
                    </button>
                    <button class="btn btn-secondary" onclick="exportInstances()">
                        <i class="fas fa-file-pdf"></i> Export Active Incidents (PDF)
                    </button>
                    <button class="btn btn-success" onclick="exportSummaryReport()">
                        <i class="fas fa-file-alt"></i> Generate Summary Report (PDF)
                    </button>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 25px; background: var(--bg-card-light); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); border: 1px solid var(--border-light);">
                <h3 style="margin-bottom: 20px; color: var(--primary-color);">Performance Metrics</h3>
                <div id="performanceMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="avgResolutionTime">--</div>
                        <div class="stat-label">Avg Resolution Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="escalationRate">--</div>
                        <div class="stat-label">Escalation Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="playbookUsage">--</div>
                        <div class="stat-label">Most Used Playbook</div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-number" id="criticalOpen">--</div>
                        <div class="stat-label">Critical Open</div>
                    </div>
                </div>
            </div>

            <div class="import-section">
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">Data Management</h3>
                <p style="margin-bottom: 15px; color: var(--text-secondary-light);">Backup and restore your application data locally.</p>
                <div class="export-options">
                    <button class="btn" onclick="exportToJSON()">
                        <i class="fas fa-file-export"></i> Export Data (JSON)
                    </button>
                    <label for="importJsonFile" class="btn btn-secondary" style="cursor: pointer;">
                        <i class="fas fa-file-import"></i> Import Data (JSON)
                    </label>
                    <input type="file" id="importJsonFile" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                </div>
            </div>
        </div>

        <div id="auditTrail" class="content-section">
            <h2 style="margin-bottom: 25px; color: var(--primary-color);">Audit Trail & Activity Log</h2>
            <div class="search-bar" style="margin-bottom: 25px;">
                <input type="text" id="auditSearch" placeholder="Filter audit logs..." onkeyup="renderAuditTrail()">
                <select id="auditFilterAction" onchange="renderAuditTrail()" style="padding: 10px 15px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--input-bg-light); color: var(--text-primary-light);">
                    <option value="">All Actions</option>
                    <option value="Incident Created">Incident Created</option>
                    <option value="Incident Updated">Incident Updated</option>
                    <option value="Incident Deleted">Incident Deleted</option>
                    <option value="Playbook Created">Playbook Created</option>
                    <option value="Playbook Updated">Playbook Updated</option>
                    <option value="Playbook Deleted">Playbook Deleted</option>
                    <option value="Report Generated">Report Generated</option>
                    <option value="Data Imported">Data Imported</option>
                    <option value="Data Exported">Data Exported</option>
                    <option value="Theme Changed">Theme Changed</option>
                </select>
                 <button onclick="renderAuditTrail()"><i class="fas fa-search"></i> Filter</button>
            </div>
            <div id="auditTableContainer" style="overflow-x: auto;">
                <table id="auditTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="createPlaybookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createPlaybookModal')">&times;</span>
            <h2 id="playbookModalTitle" style="margin-bottom: 25px; color: var(--primary-color);">Create New Playbook</h2>
            
            <form id="playbookForm">
                <input type="hidden" id="playbookId">
                <div class="form-group">
                    <label for="playbookTitle">Playbook Title</label>
                    <input type="text" id="playbookTitle" required placeholder="e.g., Malware Detection Response">
                </div>
                
                <div class="form-group">
                    <label for="alertType">Alert Type</label>
                    <select id="alertType" required>
                        <option value="">Select Alert Type</option>
                        <option value="Malware">Malware</option>
                        <option value="Phishing">Phishing</option>
                        <option value="Data Breach">Data Breach</option>
                        <option value="DDoS">DDoS Attack</option>
                        <option value="Insider Threat">Insider Threat</option>
                        <option value="Network Intrusion">Network Intrusion</option>
                        <option value="Ransomware">Ransomware</option>
                        <option value="Social Engineering">Social Engineering</option>
                        <option value="Zero-Day">Zero-Day Exploit</option>
                        <option value="Web Attack">Web Application Attack</option>
                        <option value="Cloud Security">Cloud Security Incident</option>
                        <option value="Physical Security">Physical Security Breach</option>
                        <option value="Compliance">Compliance Violation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="severity">Severity Level</label>
                    <select id="severity" required>
                        <option value="">Select Severity</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="Brief description of the playbook purpose and scope, including prerequisites and target audience."></textarea>
                </div>
                
                <div class="step-builder">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Playbook Steps</h4>
                    <div class="step-input-group">
                        <input type="text" id="newStepInput" placeholder="Enter a detailed step description (e.g., 'Check firewall logs for blocked connections').">
                        <button type="button" class="btn" onclick="addStep()"><i class="fas fa-plus"></i> Add Step</button>
                    </div>
                    <ul class="step-list" id="stepList">
                        </ul>
                </div>
                
                <div style="margin-top: 25px;">
                    <button type="submit" class="btn" id="submitPlaybookBtn">
                        <i class="fas fa-save"></i> Create Playbook
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createPlaybookModal')">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="createInstanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createInstanceModal')">&times;</span>
            <h2 style="margin-bottom: 25px; color: var(--primary-color);">Create New Incident Instance</h2>
            
            <form id="createInstanceForm">
                <div class="form-group">
                    <label for="instancePlaybook">Select Playbook</label>
                    <select id="instancePlaybook" required>
                        <option value="">Select a Playbook</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="incidentTitle">Incident Title</label>
                    <input type="text" id="incidentTitle" required placeholder="Brief description of the incident (e.g., Compromised account detected)">
                </div>
                
                <div class="form-group">
                    <label for="affectedAssets">Affected Assets (Comma-separated)</label>
                    <input type="text" id="affectedAssets" placeholder="e.g., WS-001, Server-DB, User_Account_X">
                </div>

                <div class="form-group">
                    <label for="assignedAnalyst">Assigned Analyst</label>
                    <select id="assignedAnalyst" required>
                        <option value="">Select Analyst</option>
                        <option value="John Smith">John Smith</option>
                        <option value="Sarah Johnson">Sarah Johnson</option>
                        <option value="Mike Chen">Mike Chen</option>
                        <option value="Emily Davis">Emily Davis</option>
                        <option value="Robert Wilson">Robert Wilson</option>
                        <option value="Lisa Anderson">Lisa Anderson</option>
                        <option value="David Miller">David Miller</option>
                        <option value="Jessica Brown">Jessica Brown</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" required>
                        <option value="">Select Priority</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="incidentNotes">Initial Notes</label>
                    <textarea id="incidentNotes" placeholder="Initial observations, context, relevant alerts, and any raw data."></textarea>
                </div>
                
                <div style="margin-top: 25px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-fire-alt"></i> Create Incident
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createInstanceModal')">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editInstanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editInstanceModal')">&times;</span>
            <h2 style="margin-bottom: 25px; color: var(--primary-color);">Update Incident Instance</h2>
            
            <form id="editInstanceForm">
                <input type="hidden" id="editInstanceId">
                
                <div class="form-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus" required>
                        <option value="new">New</option>
                        <option value="in-progress">In Progress</option>
                        <option value="escalated">Escalated</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editAssignedAnalyst">Assigned Analyst</label>
                    <select id="editAssignedAnalyst" required>
                        <option value="John Smith">John Smith</option>
                        <option value="Sarah Johnson">Sarah Johnson</option>
                        <option value="Mike Chen">Mike Chen</option>
                        <option value="Emily Davis">Emily Davis</option>
                        <option value="Robert Wilson">Robert Wilson</option>
                        <option value="Lisa Anderson">Lisa Anderson</option>
                        <option value="David Miller">David Miller</option>
                        <option value="Jessica Brown">Jessica Brown</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editPriority">Priority</label>
                    <select id="editPriority" required>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="editAffectedAssets">Affected Assets (Comma-separated)</label>
                    <input type="text" id="editAffectedAssets" placeholder="e.g., WS-001, Server-DB, User_Account_X">
                </div>
                
                <div class="form-group">
                    <label for="progressNotes">Progress Notes</label>
                    <textarea id="progressNotes" placeholder="Add detailed notes about progress, findings, actions taken, and next steps."></textarea>
                </div>
                
                <div style="margin-top: 25px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-sync-alt"></i> Update Incident
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editInstanceModal')">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detailsModal')">&times;</span>
            <h2 id="detailsModalTitle" style="margin-bottom: 25px; color: var(--primary-color);">Details</h2>
            <div id="detailsModalBody">
                </div>
            <div style="margin-top: 30px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('detailsModal')">
                    <i class="fas fa-check"></i> Close
                </button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">Confirm Action</h3>
            <p id="confirmationMessage" style="margin-bottom: 30px; font-size: 1.1rem; color: var(--text-primary-light);"></p>
            <div style="display: flex; justify-content: center; gap: 20px;">
                <button class="btn btn-danger" id="confirmYesBtn">Yes, Proceed</button>
                <button class="btn btn-secondary" id="confirmNoBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Data storage
        let playbooks = [];
        let instances = [];
        let activityLog = []; // This will serve as our audit trail
        let currentSteps = []; // Define currentSteps globally for playbook creation/editing
        let editingPlaybookId = null; // Track which playbook is being edited

        // Global jsPDF instance (from cdn)
        const { jsPDF } = window.jspdf;

        // --- Simulated Backend Delay & Loading States ---
        const MIN_LOADING_TIME = 800; // Minimum time for loading animation in milliseconds
        const MAX_LOADING_TIME = 2000; // Maximum time for loading animation

        function showLoading(message = "Processing...", subtext = "Securely communicating with backend services...") {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function simulateBackendOperation(loadingMessage, operationFunction, successMessage, errorMessage) {
            showLoading(loadingMessage);
            const startTime = Date.now();

            try {
                await operationFunction();
                const endTime = Date.now();
                const elapsedTime = endTime - startTime;
                const remainingTime = Math.max(0, MIN_LOADING_TIME - elapsedTime);

                await new Promise(resolve => setTimeout(resolve, remainingTime)); // Ensure min loading time
                
                showToast(successMessage || 'Operation completed successfully!', 'success');
            } catch (error) {
                console.error("Simulated Backend Error:", error);
                showToast(errorMessage || 'An unexpected error occurred. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Core Application Initialization & Setup ---
        document.addEventListener('DOMContentLoaded', async function() {
            // Simulate initial data loading from a backend
            await simulateBackendOperation(
                'Initializing application data...',
                () => new Promise(resolve => {
                    setTimeout(() => {
                        loadSampleData();
                        resolve();
                    }, Math.random() * (MAX_LOADING_TIME - MIN_LOADING_TIME) + MIN_LOADING_TIME);
                }),
                'Application initialized. Data loaded securely.',
                'Failed to load initial data.'
            );
            
            loadThemePreference(); // Load theme on start
            updateDashboard();
            renderPlaybooks();
            renderInstances();
            updateInstancePlaybookOptions();
            initializeHelp(); // Call help text initialization

            // Attach event listeners for custom confirmation modal
            document.getElementById('confirmYesBtn').onclick = () => {
                if (window.currentConfirmCallback) {
                    window.currentConfirmCallback(true);
                }
                closeModal('confirmationModal');
            };
            document.getElementById('confirmNoBtn').onclick = () => {
                if (window.currentConfirmCallback) {
                    window.currentConfirmCallback(false);
                }
                closeModal('confirmationModal');
            };
        });

        // --- Data Loading & Persistence (Simulated for Client-Side) ---
        // In a real enterprise app, this would fetch data from a backend API
        function loadSampleData() {
            // Check localStorage for existing data first, if not found, load sample data
            const savedPlaybooks = localStorage.getItem('playbooks');
            const savedInstances = localStorage.getItem('instances');
            const savedActivityLog = localStorage.getItem('activityLog');

            if (savedPlaybooks && savedInstances && savedActivityLog) {
                try {
                    playbooks = JSON.parse(savedPlaybooks).map(p => ({
                        ...p,
                        created: new Date(p.created).toISOString() // Ensure date objects are re-serialized
                    }));
                    instances = JSON.parse(savedInstances).map(i => ({
                        ...i,
                        created: new Date(i.created).toISOString(),
                        updated: new Date(i.updated).toISOString(),
                        resolvedAt: i.resolvedAt ? new Date(i.resolvedAt).toISOString() : undefined
                    }));
                    activityLog = JSON.parse(savedActivityLog).map(a => ({
                        ...a,
                        timestamp: new Date(a.timestamp).toISOString() // Ensure date objects
                    })).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // Always sort latest first
                    // showToast('Local data loaded successfully!', 'info', 2000); // This toast is now handled by simulateBackendOperation
                    return; // Data loaded, exit function
                } catch (e) {
                    console.error("Error loading data from localStorage, loading sample data:", e);
                    // showToast('Corrupted local data detected, loading sample data.', 'error', 3000); // Handled by simulateBackendOperation
                    // Clear corrupted data
                    localStorage.removeItem('playbooks');
                    localStorage.removeItem('instances');
                    localStorage.removeItem('activityLog');
                }
            }

            // --- Sample Data (only loaded if no valid data in localStorage) ---
            playbooks = [
                {
                    id: 1,
                    title: "Malware Detection & Containment",
                    alertType: "Malware",
                    severity: "Critical",
                    description: "Comprehensive response procedure for critical malware detection alerts, focusing on rapid containment and eradication. This playbook applies to all endpoint and server alerts from EDR/AV solutions.",
                    steps: [
                        "Verify alert legitimacy and context (e.g., user report, EDR telemetry).",
                        "Isolate affected systems immediately (network segmentation, disable NIC).",
                        "Collect forensic evidence (memory dump, disk image, process list).",
                        "Analyze malware signature/behavior in a quarantined sandbox environment.",
                        "Identify persistence mechanisms and lateral movement indicators.",
                        "Implement containment measures across affected network segments.",
                        "Notify relevant stakeholders (Incident Response Team Lead, Legal, Communications).",
                        "Initiate eradication: remove malware, restore from clean backups, patch vulnerabilities.",
                        "Conduct post-incident review and update security controls/playbooks.",
                        "Document all findings, actions, and lessons learned in the incident report."
                    ],
                    created: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days ago
                    usageCount: 25
                },
                {
                    id: 2,
                    title: "Phishing Email Investigation & Remediation",
                    alertType: "Phishing",
                    severity: "High",
                    description: "Standard operating procedure for investigating user-reported or automated phishing email detections. Focuses on preventing credential compromise and malware delivery.",
                    steps: [
                        "Confirm email authenticity and analyze headers/links safely (e.g., URL sandbox).",
                        "Determine if email was delivered to other users (email gateway logs).",
                        "If malicious, block sender domain/IP and hash across email security solutions.",
                        "Check for user interaction (clicked links, downloaded attachments).",
                        "If credentials compromised, force password reset and review MFA/session tokens.",
                        "If malware delivered, initiate Malware Detection & Containment playbook (PB-001).",
                        "Update email security filters and provide user awareness training on findings.",
                        "Document findings, affected users, and completed actions."
                    ],
                    created: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(), // 25 days ago
                    usageCount: 18
                },
                {
                    id: 3,
                    title: "Unauthorized Access Detection (Cloud)",
                    alertType: "Cloud Security",
                    severity: "High",
                    description: "Response to suspicious login attempts or unauthorized access patterns in cloud environments (e.g., AWS, Azure, GCP).",
                    steps: [
                        "Verify suspicious activity in cloud logs (CloudTrail, Azure AD, GCP Audit Logs).",
                        "Identify affected identity/resource (IAM role, user, VM).",
                        "Suspend/disable compromised credentials/resources.",
                        "Review recent API calls/resource modifications by the compromised identity.",
                        "Rotate affected credentials and enforce MFA.",
                        "Assess scope of access and potential data exfiltration.",
                        "Notify cloud provider security teams if external compromise confirmed.",
                        "Implement stricter access controls and monitoring.",
                        "Document incident details and mitigation steps."
                    ],
                    created: new Date(Date.now() - 40 * 24 * 60 * 60 * 1000).toISOString(), // 40 days ago
                    usageCount: 10
                },
                {
                    id: 4,
                    title: "DDoS Attack Mitigation",
                    alertType: "DDoS",
                    severity: "Critical",
                    description: "Playbook for responding to and mitigating Distributed Denial of Service (DDoS) attacks targeting public-facing infrastructure.",
                    steps: [
                        "Confirm DDoS attack (traffic patterns, service availability, external reports).",
                        "Activate DDoS protection services (e.g., Cloudflare, Akamai, AWS Shield).",
                        "Notify network and infrastructure teams.",
                        "Identify attack vector (SYN flood, UDP amplification, HTTP flood).",
                        "Implement specific mitigation rules/filters based on attack vector.",
                        "Monitor traffic flow and service health during mitigation.",
                        "Communicate status updates to stakeholders (management, affected customers).",
                        "Conduct post-attack analysis and review attack signature for future prevention."
                    ],
                    created: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(), // 15 days ago
                    usageCount: 5
                },
                {
                    id: 5,
                    title: "Insider Threat Investigation",
                    alertType: "Insider Threat",
                    severity: "High",
                    description: "Protocol for investigating suspected malicious insider activity or data exfiltration by trusted employees.",
                    steps: [
                        "Gather initial intelligence (HR, IT, manager reports, system logs).",
                        "Initiate covert monitoring on suspect accounts/systems.",
                        "Collect forensic evidence (network traffic, endpoint activity, email).",
                        "Engage Legal and HR departments for policy review and action.",
                        "Interview involved parties (if approved by legal/HR).",
                        "Contain threat (revoke access, isolate system).",
                        "Perform data recovery and integrity checks.",
                        "Document findings and recommend disciplinary/legal actions."
                    ],
                    created: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString(), // 60 days ago
                    usageCount: 3
                },
                {
                    id: 6,
                    title: "Ransomware Remediation",
                    alertType: "Ransomware",
                    severity: "Critical",
                    description: "Dedicated playbook for containing, eradicating, and recovering from active ransomware infections.",
                    steps: [
                        "Immediately isolate all infected systems and network segments.",
                        "Determine ransomware strain and attack vector (if possible).",
                        "Identify affected data and backup status.",
                        "Engage external threat intelligence / forensics experts.",
                        "DO NOT pay ransom without executive/legal approval.",
                        "Begin recovery from immutable backups.",
                        "Rebuild systems from scratch, ensuring all vulnerabilities are patched.",
                        "Conduct thorough post-mortem analysis."
                    ],
                    created: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(), // 10 days ago
                    usageCount: 7
                }
            ];

            instances = [
                {
                    id: 101,
                    playbookId: 1,
                    playbookTitle: "Malware Detection & Containment",
                    incidentTitle: "High-severity malware detected on WS-CORP-FIN-005",
                    affectedAssets: "WS-CORP-FIN-005, FIN-SHARE-01",
                    assignedAnalyst: "John Smith",
                    priority: "Critical",
                    status: "in-progress",
                    created: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 days ago
                    updated: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
                    notes: "EDR alert: 'WannaCry' signature detected. System immediately quarantined by automated rule. Initial analysis shows potential encryption of local files. User reported slow performance and unusual pop-ups.",
                    progressNotes: "Confirmed alert legitimacy. System isolated and network access blocked. Memory dump and disk image initiated for forensic analysis. Initial sandbox analysis shows ransomware activity. Notified Finance department head. Next steps: Analyze C2 traffic, identify patient zero, eradicate.",
                },
                {
                    id: 102,
                    playbookId: 2,
                    playbookTitle: "Phishing Email Investigation & Remediation",
                    incidentTitle: "Multiple users reported suspicious invoice email with malicious attachment",
                    affectedAssets: "User_Email_Accounts (5 users), Email_Gateway",
                    assignedAnalyst: "Sarah Johnson",
                    priority: "High",
                    status: "new",
                    created: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
                    updated: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    notes: "Received multiple user reports regarding an invoice email from 'invoice@example.com'. Subject: 'Urgent Invoice Payment Due'. Attachment: 'invoice.zip'. Initial checks show sender is external and domain reputation is low. Attachment contains a .js file.",
                    progressNotes: ""
                },
                {
                    id: 103,
                    playbookId: 1,
                    playbookTitle: "Malware Detection & Containment",
                    incidentTitle: "Server XYZ infected with ransomware (CONFIRMED)",
                    affectedAssets: "SERVER-APP-XYZ, DB-SQL-001, Storage-SAN-03",
                    assignedAnalyst: "Mike Chen",
                    priority: "Critical",
                    status: "escalated",
                    created: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // 3 days ago
                    updated: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 days ago
                    notes: "Initial alert from SIEM: high volume of file encryption events on SERVER-APP-XYZ. Access to DB-SQL-001 from SERVER-APP-XYZ detected just prior to encryption. Initial investigation shows server is inaccessible.",
                    progressNotes: "Confirmed ransomware. Isolated SERVER-APP-XYZ and DB-SQL-001. Engaged Level 2 IR team for advanced forensics. Data backup recovery process initiated for DB-SQL-001. Executive leadership notified. Need to determine source of infection and restore critical services.",
                },
                {
                    id: 104,
                    playbookId: 2,
                    playbookTitle: "Phishing Email Investigation & Remediation",
                    incidentTitle: "User credentials compromised via fake Office 365 login page",
                    affectedAssets: "User_Account_E.Davis, Office365_Tenant",
                    assignedAnalyst: "Emily Davis",
                    priority: "High",
                    status: "closed", // Mark as closed
                    created: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days ago
                    updated: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(), // 6 days ago
                    resolvedAt: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
                    notes: "User reported clicking a link in an email and entering credentials on a page that looked like Office 365 login. Realized it was fake after logging in. No MFA enabled on account.",
                    progressNotes: "Forced password reset for E.Davis. Reviewed Office 365 audit logs for suspicious login attempts/activity from E.Davis's account. No unauthorized access observed. Phishing URL added to web proxy block list. User received additional security awareness training. Recommended MFA enforcement policy change.",
                },
                {
                    id: 105,
                    playbookId: 3,
                    playbookTitle: "Unauthorized Access Detection (Cloud)",
                    incidentTitle: "Suspicious login from unusual GEO-IP in AWS console",
                    affectedAssets: "AWS_IAM_Role_DevOps, EC2_Prod_Web",
                    assignedAnalyst: "Robert Wilson",
                    priority: "High",
                    status: "in-progress",
                    created: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
                    updated: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    notes: "Cloud SIEM alert: AWS console login from IP 1.2.3.4 (Nigeria) for IAM role 'DevOps-Admin'. Normal logins are from US/EU. User confirmed they did not login from this location. No MFA on this role.",
                    progressNotes: "Suspended 'DevOps-Admin' IAM role. Initiated CloudTrail review for recent activities from the suspicious IP. Notified cloud engineering team. Next steps: Forensic analysis of accessed resources, re-enable MFA for all critical roles.",
                },
                {
                    id: 106,
                    playbookId: 4,
                    playbookTitle: "DDoS Attack Mitigation",
                    incidentTitle: "Persistent SYN Flood attack on public web server",
                    affectedAssets: "WEB-SERVER-01, LoadBalancer-PROD",
                    assignedAnalyst: "David Miller",
                    priority: "Critical",
                    status: "in-progress",
                    created: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(), // 1 hour ago
                    updated: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30 mins ago
                    notes: "Alert from network monitoring: High volume of SYN packets to WEB-SERVER-01. Service unavailable. Initial signs of DDoS. Threat actor IP ranges identified and being blocked at edge.",
                    progressNotes: "Confirmed DDoS via traffic analysis. Activated Cloudflare DDoS protection. Monitoring traffic. Attack source appears to be from botnet IPs. Initiated BGP blackholing for persistent offenders. Next steps: Traffic scrubbing fine-tuning.",
                },
                {
                    id: 107,
                    playbookId: 5,
                    playbookTitle: "Insider Threat Investigation",
                    incidentTitle: "Unusual data download activity by departing employee",
                    affectedAssets: "User_Account_J.Doe, FileShare_HR",
                    assignedAnalyst: "Jessica Brown",
                    priority: "High",
                    status: "new",
                    created: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
                    updated: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                    notes: "HR reported J.Doe gave notice. Security logs show large file downloads from HR share to personal cloud storage. Investigation needed for potential data exfiltration.",
                    progressNotes: ""
                },
                {
                    id: 108,
                    playbookId: 6,
                    playbookTitle: "Ransomware Remediation",
                    incidentTitle: "Critical Server infected with new variant of Conti ransomware",
                    affectedAssets: "SQL-DB-PROD-01, FILE-SRV-02, AD-CONTROLLER-01",
                    assignedAnalyst: "Robert Wilson",
                    priority: "Critical",
                    status: "escalated",
                    created: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(), // 12 hours ago
                    updated: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(), // 6 hours ago
                    notes: "Detected via EDR, file encryption on critical SQL server. Rapid spread to file server and active directory. Ransom note appeared. Initial containment failed.",
                    progressNotes: "Immediate network isolation of affected segments. Engaged external IR firm. Performed memory dump and initial forensic snapshot. Working on identifying initial compromise vector. Do NOT pay ransom.",
                }
            ];

            activityLog = [
                { action: "Incident Created", details: `New incident "Persistent SYN Flood attack on public web server" (Prio: Critical) assigned to David Miller`, timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Updated", details: `Incident "Persistent SYN Flood attack on public web server" updated: Progress notes added.`, timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "Unusual data download activity by departing employee" (Prio: High) assigned to Jessica Brown`, timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "Critical Server infected with new variant of Conti ransomware" (Prio: Critical) assigned to Robert Wilson`, timestamp: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Escalated", details: `Incident "Critical Server infected with new variant of Conti ransomware" status changed from new to escalated.`, timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "High-severity malware detected on WS-CORP-FIN-005" (Prio: Critical) assigned to John Smith`, timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Updated", details: `Incident "High-severity malware detected on WS-CORP-FIN-005" updated: Progress notes added.`, timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Playbook Updated", details: "Updated steps for 'Phishing Email Investigation & Remediation'", timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "Multiple users reported suspicious invoice email with malicious attachment" (Prio: High) assigned to Sarah Johnson`, timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "Server XYZ infected with ransomware (CONFIRMED)" (Prio: Critical) assigned to Mike Chen`, timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Escalated", details: `Incident "Server XYZ infected with ransomware (CONFIRMED)" status changed from in-progress to escalated.`, timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Updated", details: `Incident "User credentials compromised via fake Office 365 login page" updated: Status: High -> closed.`, timestamp: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Incident Created", details: `New incident "Suspicious login from unusual GEO-IP in AWS console" (Prio: High) assigned to Robert Wilson`, timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Playbook Created", details: `New playbook "DDoS Attack Mitigation" created`, timestamp: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Playbook Created", details: `New playbook "Insider Threat Investigation" created`, timestamp: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Playbook Created", details: `New playbook "Ransomware Remediation" created`, timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString() },
                { action: "Data Imported", details: "Application data imported from JSON file", timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000 - 1000).toISOString() },
                { action: "Data Exported", details: "Application data exported to JSON", timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000 - 500).toISOString() }
            ].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

            // Save initial sample data to localStorage if it was empty
            saveDataToLocalStorage();
        }

        // --- Client-Side Data Persistence ---
        function saveDataToLocalStorage() {
            localStorage.setItem('playbooks', JSON.stringify(playbooks));
            localStorage.setItem('instances', JSON.stringify(instances));
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        // --- Theme Management ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            const themeToggleIcon = document.querySelector('.theme-toggle i');
            if (isDarkMode) {
                themeToggleIcon.classList.remove('fa-sun');
                themeToggleIcon.classList.add('fa-moon');
            } else {
                themeToggleIcon.classList.remove('fa-moon');
                themeToggleIcon.classList.add('fa-sun');
            }
            activityLog.unshift({ action: "Theme Changed", details: `Switched to ${isDarkMode ? 'Dark' : 'Light'} Mode`, timestamp: new Date().toISOString() });
            updateDashboard();
            renderAuditTrail(); // Re-render audit trail to reflect theme changes in action badges
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle i').classList.remove('fa-sun');
                document.querySelector('.theme-toggle i').classList.add('fa-moon');
            } else {
                document.body.classList.add('light-mode');
                document.querySelector('.theme-toggle i').classList.remove('fa-moon');
                document.querySelector('.theme-toggle i').classList.add('fa-sun');
            }
        }

        // --- Main Navigation ---
        function showSection(sectionId, clickedButton) {
            simulateBackendOperation(`Loading ${sectionId.replace(/([A-Z])/g, ' $1').toLowerCase()}...`, () => new Promise(resolve => {
                setTimeout(() => {
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    document.getElementById(sectionId).classList.add('active');
                    if (clickedButton) {
                        clickedButton.classList.add('active');
                    }
                    
                    if (sectionId === 'dashboard') {
                        updateDashboard();
                    } else if (sectionId === 'playbooks') {
                        renderPlaybooks();
                    } else if (sectionId === 'instances') {
                        renderInstances();
                    } else if (sectionId === 'auditTrail') { // NEW: Render audit trail when its tab is selected
                        renderAuditTrail();
                    }
                    resolve();
                }, Math.random() * 300 + 200); // Shorter delay for navigation
            }), `Mapsd to ${sectionId.replace(/([A-Z])/g, ' $1').toLowerCase()}.`);
        }

        // --- Dashboard Functions ---
        function updateDashboard() {
            document.getElementById('totalPlaybooks').textContent = playbooks.length;
            document.getElementById('activeInstances').textContent = instances.filter(i => i.status !== 'resolved' && i.status !== 'closed').length;
            
            const today = new Date();
            const resolvedTodayCount = instances.filter(i => 
                (i.status === 'resolved' || i.status === 'closed') && i.resolvedAt && new Date(i.resolvedAt).toDateString() === today.toDateString() 
            ).length;
            document.getElementById('resolvedToday').textContent = resolvedTodayCount;
            
            document.getElementById('escalatedCount').textContent = instances.filter(i => i.status === 'escalated').length;
            document.getElementById('criticalOpen').textContent = instances.filter(i => (i.status !== 'resolved' && i.status !== 'closed') && i.priority === 'Critical').length;
            
            const recentActivityEl = document.getElementById('recentActivity');
            if (activityLog.length > 0) {
                recentActivityEl.innerHTML = activityLog.slice(0, 5).map(activity => 
                    `<div style="margin-bottom: 10px; padding: 10px; background: var(--step-bg-light); border-radius: 6px; border-left: 4px solid var(--primary-color); color: var(--text-primary-light);">
                        <span class="action-badge ${activity.action.split(' ')[0].toLowerCase()}">${activity.action.split(' ')[0]}</span>
                        <strong style="color: var(--text-primary-light);">${activity.action.substring(activity.action.indexOf(' ') + 1)}</strong><br>
                        <small style="color: var(--text-secondary-light);">${new Date(activity.timestamp).toLocaleString()}</small>
                        <p style="color: var(--text-secondary-light); margin-top: 5px; font-size: 0.9em;">${activity.details}</p>
                    </div>`
                ).join('');
            } else {
                recentActivityEl.innerHTML = '<p style="color: var(--text-secondary-light); font-style: italic;">No recent activity</p>';
            }

            updatePerformanceMetrics();
        }

        function updatePerformanceMetrics() {
            const resolvedInstances = instances.filter(i => (i.status === 'resolved' || i.status === 'closed') && i.resolvedAt);
            let totalResolutionTime = 0;
            resolvedInstances.forEach(instance => {
                const createdTime = new Date(instance.created).getTime();
                const resolvedTime = new Date(instance.resolvedAt).getTime();
                if (resolvedTime > createdTime) { 
                    totalResolutionTime += (resolvedTime - createdTime); 
                }
            });

            const avgTimeMs = resolvedInstances.length > 0 ? totalResolutionTime / resolvedInstances.length : 0;
            const avgTimeHours = avgTimeMs / (1000 * 60 * 60); 
            
            document.getElementById('avgResolutionTime').textContent = avgTimeHours > 0 ? `${avgTimeHours.toFixed(1)} hours` : "--";

            const escalationRate = instances.length > 0 ? 
                `${((instances.filter(i => i.status === 'escalated').length / instances.length) * 100).toFixed(1)}%` : "--";
            document.getElementById('escalationRate').textContent = escalationRate;

            const playbookUsageCounts = {};
            playbooks.forEach(pb => playbookUsageCounts[pb.title] = 0); // Initialize with 0
            instances.forEach(instance => {
                const playbook = playbooks.find(p => p.id === instance.playbookId);
                if (playbook) {
                    playbookUsageCounts[playbook.title] = (playbookUsageCounts[playbook.title] || 0) + 1;
                }
            });

            // Update usageCount property in playbooks array for accurate tracking
            playbooks.forEach(pb => {
                pb.usageCount = playbookUsageCounts[pb.title] || 0;
            });


            const mostUsedTitle = Object.keys(playbookUsageCounts).length > 0 ? 
                Object.keys(playbookUsageCounts).reduce((a, b) => playbookUsageCounts[a] > playbookUsageCounts[b] ? a : b) : "--";
            document.getElementById('playbookUsage').textContent = mostUsedTitle;
        }

        // --- Playbook Functions ---
        function renderPlaybooks() {
            const grid = document.getElementById('playbookGrid');
            const searchQuery = document.getElementById('playbookSearch').value.toLowerCase();
            
            const filteredPlaybooks = playbooks.filter(playbook => 
                playbook.title.toLowerCase().includes(searchQuery) ||
                playbook.alertType.toLowerCase().includes(searchQuery) ||
                playbook.description.toLowerCase().includes(searchQuery) ||
                playbook.steps.some(step => step.toLowerCase().includes(searchQuery))
            ).sort((a,b) => b.id - a.id); // Sort by latest created first

            if (playbooks.length === 0) { // Check if there are any playbooks at all
                grid.innerHTML = `<p style="text-align: center; color: var(--text-secondary-light); margin-top: 50px; font-size: 1.1em;">No playbooks defined yet. Click "Create New Playbook" to get started!</p>`;
                return;
            }
            
            if (filteredPlaybooks.length === 0 && searchQuery !== '') {
                grid.innerHTML = `<p style="text-align: center; color: var(--text-secondary-light); margin-top: 50px; font-size: 1.1em;">No playbooks found matching your search criteria.</p>`;
                return;
            } 

            grid.innerHTML = filteredPlaybooks.map(playbook => `
                <div class="playbook-card">
                    <div class="playbook-header">
                        <div>
                            <div class="playbook-title">${playbook.title}</div>
                            <span class="alert-type">${playbook.alertType}</span>
                        </div>
                        <div style="text-align: right; font-size: 0.9rem; color: var(--text-secondary-light);">
                            <div>Severity: <strong>${playbook.severity}</strong></div>
                            <div>Used: ${playbook.usageCount || 0} times</div>
                        </div>
                    </div>
                    <div class="playbook-meta">
                        <span>Created: ${new Date(playbook.created).toLocaleDateString()}</span>
                        <span>${playbook.steps.length} steps</span>
                    </div>
                    <p style="margin: 15px 0; color: var(--text-secondary-light); font-size: 0.95rem;">${playbook.description.substring(0, 150)}${playbook.description.length > 150 ? '...' : ''}</p>
                    <div class="steps-list">
                        ${playbook.steps.slice(0, 3).map((step, i) => `<div class="step-item">${i + 1}. ${step.substring(0, 50)}${step.length > 50 ? '...' : ''}</div>`).join('')}
                        ${playbook.steps.length > 3 ? `<div style="text-align: center; color: var(--text-secondary-light); font-style: italic; margin-top: 10px;">+ ${playbook.steps.length - 3} more steps</div>` : ''}
                    </div>
                    <div class="playbook-actions">
                        <button class="btn btn-sm" onclick="simulateBackendOperation('Fetching playbook details...', () => showPlaybookDetails(${playbook.id}), 'Playbook details loaded.')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="simulateBackendOperation('Loading playbook for editing...', () => editPlaybook(${playbook.id}), 'Playbook ready for editing.')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-success btn-sm" onclick="simulateBackendOperation('Initiating incident from playbook...', () => window.createInstanceFromPlaybook(${playbook.id}), 'Incident creation initialized.')">
                            <i class="fas fa-play"></i> Use
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePlaybook(${playbook.id})">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
            saveDataToLocalStorage(); 
        }

        function filterPlaybooks() {
            renderPlaybooks();
        }

        function showCreatePlaybookModal() {
            document.getElementById('playbookModalTitle').textContent = 'Create New Playbook';
            document.getElementById('submitPlaybookBtn').innerHTML = `<i class="fas fa-save"></i> Create Playbook`;
            document.getElementById('playbookForm').reset();
            document.getElementById('playbookId').value = '';
            currentSteps = [];
            updateStepList();
            document.getElementById('createPlaybookModal').style.display = 'flex'; // Use flex for centering
            editingPlaybookId = null; 
        }

        function addStep() {
            const stepInput = document.getElementById('newStepInput');
            const stepText = stepInput.value.trim();
            
            if (stepText) {
                currentSteps.push(stepText);
                updateStepList();
                stepInput.value = '';
            } else {
                showToast('Step description cannot be empty.', 'error');
            }
        }

        function updateStepList() {
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = currentSteps.map((step, index) => `
                <li>
                    <span>${index + 1}. ${step}</span>
                    <button type="button" onclick="removeStep(${index})"><i class="fas fa-minus-circle"></i> Remove</button>
                </li>
            `).join('');
        }

        function removeStep(index) {
            currentSteps.splice(index, 1);
            updateStepList();
        }

        document.getElementById('playbookForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('playbookId').value;
            const playbookTitle = document.getElementById('playbookTitle').value;
            const alertType = document.getElementById('alertType').value;
            const severity = document.getElementById('severity').value;
            const description = document.getElementById('description').value;

            if (currentSteps.length === 0) {
                showToast('Playbook must have at least one step.', 'error');
                return;
            }

            simulateBackendOperation(
                id ? `Updating playbook "${playbookTitle}"...` : `Creating new playbook "${playbookTitle}"...`,
                () => new Promise(resolve => {
                    setTimeout(() => {
                        if (id) {
                            const playbookIndex = playbooks.findIndex(p => p.id === parseInt(id));
                            if (playbookIndex > -1) {
                                const oldTitle = playbooks[playbookIndex].title;
                                playbooks[playbookIndex] = {
                                    ...playbooks[playbookIndex],
                                    title: playbookTitle,
                                    alertType: alertType,
                                    severity: severity,
                                    description: description,
                                    steps: [...currentSteps]
                                };
                                activityLog.unshift({ 
                                    action: "Playbook Updated",
                                    details: `Playbook "${oldTitle}" updated to "${playbookTitle}"`,
                                    timestamp: new Date().toISOString()
                                });
                            }
                        } else {
                            const newPlaybook = {
                                id: Date.now(),
                                title: playbookTitle,
                                alertType: alertType,
                                severity: severity,
                                description: description,
                                steps: [...currentSteps],
                                created: new Date().toISOString(),
                                usageCount: 0
                            };
                            playbooks.unshift(newPlaybook); 
                            activityLog.unshift({ 
                                action: "Playbook Created",
                                details: `New playbook "${newPlaybook.title}" created`,
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        renderPlaybooks();
                        updateInstancePlaybookOptions();
                        closeModal('createPlaybookModal');
                        
                        e.target.reset(); // Use e.target.reset() instead of this.reset()
                        currentSteps = [];
                        editingPlaybookId = null;
                        updateDashboard(); 
                        saveDataToLocalStorage();
                        renderAuditTrail();
                        resolve();
                    }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                }),
                id ? `Playbook "${playbookTitle}" updated successfully!` : `Playbook "${playbookTitle}" created successfully!`,
                `Failed to ${id ? 'update' : 'create'} playbook "${playbookTitle}".`
            );
        });

        function editPlaybook(id) {
            const playbook = playbooks.find(p => p.id === id);
            if (!playbook) {
                showToast('Playbook not found!', 'error');
                return;
            }
            
            editingPlaybookId = id;
            document.getElementById('playbookModalTitle').textContent = `Edit Playbook: ${playbook.title}`;
            document.getElementById('submitPlaybookBtn').innerHTML = `<i class="fas fa-save"></i> Update Playbook`;
            
            document.getElementById('playbookId').value = playbook.id;
            document.getElementById('playbookTitle').value = playbook.title;
            document.getElementById('alertType').value = playbook.alertType;
            document.getElementById('severity').value = playbook.severity;
            document.getElementById('description').value = playbook.description;
            currentSteps = [...playbook.steps]; // Copy steps for editing
            updateStepList();

            document.getElementById('createPlaybookModal').style.display = 'flex'; // Use flex for centering
        }

        function deletePlaybook(id) {
            showConfirmation('Are you sure you want to delete this playbook? This action is irreversible and will not delete existing incidents that used it. You might want to update incidents if this playbook is no longer valid.', () => {
                simulateBackendOperation(
                    'Deleting playbook...',
                    () => new Promise(resolve => {
                        setTimeout(() => {
                            const playbook = playbooks.find(p => p.id === id);
                            if (!playbook) {
                                throw new Error('Playbook not found!'); // Trigger error for simulateBackendOperation
                            }
                            playbooks = playbooks.filter(p => p.id !== id);
                            renderPlaybooks();
                            updateInstancePlaybookOptions();
                            
                            activityLog.unshift({ 
                                action: "Playbook Deleted",
                                details: `Playbook "${playbook.title}" (ID: ${playbook.id}) was deleted`,
                                timestamp: new Date().toISOString()
                            });
                            updateDashboard(); 
                            saveDataToLocalStorage();
                            renderAuditTrail();
                            resolve();
                        }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                    }),
                    'Playbook deleted successfully!',
                    'Failed to delete playbook.'
                );
            });
        }

        // Moved function for better accessibility from HTML onclicks
        function createInstanceFromPlaybook(playbookId) {
            document.getElementById('instancePlaybook').value = playbookId;
            showSection('instances', document.querySelector('.nav-btn:nth-child(3)')); 
            showCreateInstanceModal();
        }

        function showPlaybookDetails(id) {
            const playbook = playbooks.find(p => p.id === id);
            if (!playbook) {
                showToast('Playbook details not found!', 'error');
                return;
            }

            const modalTitle = document.getElementById('detailsModalTitle');
            const modalBody = document.getElementById('detailsModalBody');

            modalTitle.textContent = `Playbook Details: ${playbook.title}`;
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h3>General Information</h3>
                    <div class="detail-grid">
                        <div><strong>Alert Type:</strong> ${playbook.alertType}</div>
                        <div><strong>Severity:</strong> ${playbook.severity}</div>
                        <div><strong>Created:</strong> ${new Date(playbook.created).toLocaleDateString()}</div>
                        <div><strong>Usage Count:</strong> ${playbook.usageCount || 0} times</div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Description</h3>
                    <p>${playbook.description}</p>
                </div>
                <div class="detail-section">
                    <h3>Steps</h3>
                    <ol>
                        ${playbook.steps.map((step, i) => `<li>${i + 1}. ${step}</li>`).join('')}
                    </ol>
                </div>
            `;
            document.getElementById('detailsModal').style.display = 'flex'; // Use flex for centering
        }

        // --- Incident Instance Functions ---
        function renderInstances() {
            const grid = document.getElementById('instanceGrid');
            const statusFilter = document.getElementById('statusFilter').value;
            const instanceSearchQuery = document.getElementById('instanceSearch').value.toLowerCase();
            
            let filteredInstances = instances.sort((a,b) => new Date(b.created) - new Date(a.created)); // Sort by latest created first

            if (statusFilter) {
                 filteredInstances = filteredInstances.filter(i => i.status === statusFilter);
            } else {
                 filteredInstances = filteredInstances.filter(i => i.status !== 'closed'); // Default to hide closed
            }

            if (instanceSearchQuery) {
                filteredInstances = filteredInstances.filter(i => 
                    i.incidentTitle.toLowerCase().includes(instanceSearchQuery) ||
                    i.assignedAnalyst.toLowerCase().includes(instanceSearchQuery) ||
                    i.playbookTitle.toLowerCase().includes(instanceSearchQuery) ||
                    (i.affectedAssets && i.affectedAssets.toLowerCase().includes(instanceSearchQuery)) ||
                    i.notes.toLowerCase().includes(instanceSearchQuery) ||
                    i.progressNotes.toLowerCase().includes(instanceSearchQuery)
                );
            }

            if (instances.length === 0) {
                 grid.innerHTML = `<p style="text-align: center; color: var(--text-secondary-light); margin-top: 50px; font-size: 1.1em;">No incident instances recorded yet. Create a new incident to track activity!</p>`;
                 return;
            }
            
            if (filteredInstances.length === 0 && (statusFilter !== '' || instanceSearchQuery !== '')) {
                grid.innerHTML = `<p style="text-align: center; color: var(--text-secondary-light); margin-top: 50px; font-size: 1.1em;">No incident instances found matching your criteria.</p>`;
                return;
            } 
            
            grid.innerHTML = filteredInstances.map(instance => `
                <div class="instance-card status-${instance.status}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: var(--primary-color); margin-bottom: 5px; font-size: 1.2rem;">${instance.incidentTitle}</h3>
                            <p style="color: var(--text-secondary-light); font-size: 0.9rem; margin-bottom: 10px;">Playbook: ${instance.playbookTitle}</p>
                        </div>
                        <span class="status-badge status-${instance.status}">${instance.status.replace('-', ' ')}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-primary-light);">
                        <div><strong>Analyst:</strong> ${instance.assignedAnalyst}</div>
                        <div><strong>Priority:</strong> ${instance.priority}</div>
                        <div><strong>Created:</strong> ${new Date(instance.created).toLocaleDateString()}</div>
                        <div><strong>Assets:</strong> ${instance.affectedAssets || 'N/A'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px; color: var(--text-primary-light);">
                        <strong>Initial Notes:</strong>
                        <p style="background: var(--step-bg-light); padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 0.9rem; color: var(--text-primary-light);">
                            ${instance.notes.substring(0, 100)}${instance.notes.length > 100 ? '...' : ''}
                        </p>
                    </div>
                    
                    ${instance.progressNotes ? `
                        <div style="margin-bottom: 15px; color: var(--text-primary-light);">
                            <strong>Latest Progress:</strong>
                            <p style="background: var(--step-bg-light); padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 0.9rem; color: var(--text-primary-light);">
                                ${instance.progressNotes.substring(0, 100)}${instance.progressNotes.length > 100 ? '...' : ''}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="simulateBackendOperation('Fetching incident details...', () => showInstanceDetails(${instance.id}), 'Incident details loaded.')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="simulateBackendOperation('Loading incident for update...', () => editInstance(${instance.id}), 'Incident ready for update.')">
                            <i class="fas fa-sync-alt"></i> Update
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportInstanceReport(${instance.id})">
                            <i class="fas fa-file-pdf"></i> Report
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInstance(${instance.id})">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
            updateDashboard(); 
            saveDataToLocalStorage();
        }

        function showCreateInstanceModal() {
            document.getElementById('createInstanceForm').reset();
            document.getElementById('createInstanceModal').style.display = 'flex'; // Use flex for centering
            updateInstancePlaybookOptions(); 
        }

        function updateInstancePlaybookOptions() {
            const select = document.getElementById('instancePlaybook');
            select.innerHTML = '<option value="">Select a Playbook</option>' + 
                playbooks.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
        }

        document.getElementById('createInstanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const playbookId = parseInt(document.getElementById('instancePlaybook').value);
            const playbook = playbooks.find(p => p.id === playbookId);
            
            if (!playbook) {
                showToast('Please select a valid playbook.', 'error');
                return;
            }

            const incidentTitle = document.getElementById('incidentTitle').value;

            simulateBackendOperation(
                `Creating new incident "${incidentTitle}"...`,
                () => new Promise(resolve => {
                    setTimeout(() => {
                        const newInstance = {
                            id: Date.now(),
                            playbookId: playbookId,
                            playbookTitle: playbook.title,
                            incidentTitle: incidentTitle,
                            affectedAssets: document.getElementById('affectedAssets').value,
                            assignedAnalyst: document.getElementById('assignedAnalyst').value,
                            priority: document.getElementById('priority').value,
                            status: 'new',
                            created: new Date().toISOString(),
                            updated: new Date().toISOString(),
                            notes: document.getElementById('incidentNotes').value,
                            progressNotes: ''
                        };
                        
                        instances.unshift(newInstance); 
                        if (playbook) {
                            playbook.usageCount = (playbook.usageCount || 0) + 1;
                        }
                        
                        renderInstances();
                        renderPlaybooks(); 
                        closeModal('createInstanceModal');
                        
                        activityLog.unshift({ 
                            action: "Incident Created",
                            details: `New incident "${newInstance.incidentTitle}" (Prio: ${newInstance.priority}) assigned to ${newInstance.assignedAnalyst}`,
                            timestamp: new Date().toISOString()
                        });
                        
                        e.target.reset();
                        updateDashboard(); 
                        saveDataToLocalStorage();
                        renderAuditTrail();
                        resolve();
                    }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                }),
                `Incident "${incidentTitle}" created successfully!`,
                `Failed to create incident "${incidentTitle}".`
            );
        });

        function editInstance(id) {
            const instance = instances.find(i => i.id === id);
            if (!instance) {
                showToast('Incident instance not found!', 'error');
                return;
            }
            
            document.getElementById('editInstanceId').value = id;
            document.getElementById('editStatus').value = instance.status;
            document.getElementById('editAssignedAnalyst').value = instance.assignedAnalyst;
            document.getElementById('editPriority').value = instance.priority;
            document.getElementById('editAffectedAssets').value = instance.affectedAssets || '';
            document.getElementById('progressNotes').value = instance.progressNotes || '';
            
            document.getElementById('editInstanceModal').style.display = 'flex'; // Use flex for centering
        }

        document.getElementById('editInstanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editInstanceId').value);
            const instance = instances.find(i => i.id === id);
            
            if (instance) {
                simulateBackendOperation(
                    `Updating incident "${instance.incidentTitle}"...`,
                    () => new Promise(resolve => {
                        setTimeout(() => {
                            const oldStatus = instance.status;
                            const oldAnalyst = instance.assignedAnalyst;
                            const oldPriority = instance.priority;

                            instance.status = document.getElementById('editStatus').value;
                            instance.assignedAnalyst = document.getElementById('editAssignedAnalyst').value;
                            instance.priority = document.getElementById('editPriority').value;
                            instance.affectedAssets = document.getElementById('editAffectedAssets').value;
                            instance.progressNotes = document.getElementById('progressNotes').value;
                            instance.updated = new Date().toISOString(); 

                            let details = `Incident "${instance.incidentTitle}" updated: `;
                            if (oldStatus !== instance.status) details += `Status: ${oldStatus} -> ${instance.status}. `;
                            if (oldAnalyst !== instance.assignedAnalyst) details += `Analyst: ${oldAnalyst} -> ${instance.assignedAnalyst}. `;
                            if (oldPriority !== instance.priority) details += `Priority: ${oldPriority} -> ${instance.priority}. `;
                            if (details === `Incident "${instance.incidentTitle}" updated: ` && instance.progressNotes.trim() !== (instances.find(i => i.id === id)?.progressNotes || '').trim()) {
                                 details += `Progress notes added.`; 
                            } else if (instance.progressNotes.trim() !== (instances.find(i => i.id === id)?.progressNotes || '').trim()) {
                                 details += `(Notes updated).`; 
                            }


                            if ((instance.status === 'resolved' || instance.status === 'closed') && !instance.resolvedAt) {
                                instance.resolvedAt = new Date().toISOString(); 
                            } else if (!(instance.status === 'resolved' || instance.status === 'closed') && instance.resolvedAt) {
                                delete instance.resolvedAt; 
                            }
                            
                            renderInstances();
                            closeModal('editInstanceModal');
                            
                            activityLog.unshift({ 
                                action: "Incident Updated",
                                details: details,
                                timestamp: new Date().toISOString()
                            });
                            updateDashboard(); 
                            saveDataToLocalStorage();
                            renderAuditTrail();
                            resolve();
                        }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                    }),
                    `Incident "${instance.incidentTitle}" updated!`,
                    `Failed to update incident "${instance.incidentTitle}".`
                );
            }
        });

        function deleteInstance(id) {
            showConfirmation('Are you sure you want to delete this incident instance? This action is irreversible and will remove all associated notes and history.', () => {
                simulateBackendOperation(
                    'Deleting incident...',
                    () => new Promise(resolve => {
                        setTimeout(() => {
                            const instance = instances.find(i => i.id === id);
                            if (!instance) {
                                throw new Error('Incident instance not found!');
                            }
                            instances = instances.filter(i => i.id !== id);
                            renderInstances();
                            
                            activityLog.unshift({ 
                                action: "Incident Deleted",
                                details: `Incident "${instance.incidentTitle}" (ID: ${instance.id}) was deleted`,
                                timestamp: new Date().toISOString()
                            });
                            updateDashboard(); 
                            saveDataToLocalStorage();
                            renderAuditTrail();
                            resolve();
                        }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                    }),
                    'Incident deleted!',
                    'Failed to delete incident.'
                );
            });
        }

        function showInstanceDetails(id) {
            const instance = instances.find(i => i.id === id);
            if (!instance) {
                showToast('Incident details not found!', 'error');
                return;
            }

            const playbook = playbooks.find(p => p.id === instance.playbookId);
            const modalTitle = document.getElementById('detailsModalTitle');
            const modalBody = document.getElementById('detailsModalBody');

            modalTitle.textContent = `Incident Details: ${instance.incidentTitle}`;
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h3>Incident Information</h3>
                    <div class="detail-grid">
                        <div><strong>Incident ID:</strong> ${instance.id}</div>
                        <div><strong>Status:</strong> <span class="status-badge status-${instance.status}">${instance.status.replace('-', ' ').toUpperCase()}</span></div>
                        <div><strong>Priority:</strong> ${instance.priority}</div>
                        <div><strong>Assigned Analyst:</strong> ${instance.assignedAnalyst}</div>
                        <div><strong>Affected Assets:</strong> ${instance.affectedAssets || 'N/A'}</div>
                        <div><strong>Created:</strong> ${new Date(instance.created).toLocaleString()}</div>
                        <div><strong>Last Updated:</strong> ${new Date(instance.updated).toLocaleString()}</div>
                        ${instance.resolvedAt ? `<div><strong>Resolved:</strong> ${new Date(instance.resolvedAt).toLocaleString()}</div>` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Playbook Applied</h3>
                    <p><strong>Title:</strong> ${instance.playbookTitle}</p>
                    <p><strong>Description:</strong> ${playbook ? playbook.description : 'N/A'}</p>
                    <button class="btn btn-info btn-sm" onclick="simulateBackendOperation('Fetching playbook details...', () => showPlaybookDetails(${instance.playbookId}), 'Playbook details loaded.')">
                        <i class="fas fa-book-open"></i> View Full Playbook
                    </button>
                </div>
                <div class="detail-section">
                    <h3>Initial Assessment Notes</h3>
                    <p>${instance.notes}</p>
                </div>
                ${instance.progressNotes ? `
                    <div class="detail-section">
                        <h3>Progress & Action Notes</h3>
                        <p>${instance.progressNotes}</p>
                    </div>
                ` : ''}
                ${playbook ? `
                    <div class="detail-section">
                        <h3>Playbook Steps (Reference)</h3>
                        <ol>
                            ${playbook.steps.map((step, i) => `<li>${i + 1}. ${step}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
            `;
            document.getElementById('detailsModal').style.display = 'flex'; // Use flex for centering
        }

        function filterInstances() {
            renderInstances(); 
        }

        // --- Audit Trail Functions ---
        function renderAuditTrail() {
            const auditTableBody = document.getElementById('auditTableBody');
            const auditSearchQuery = document.getElementById('auditSearch').value.toLowerCase();
            const auditFilterAction = document.getElementById('auditFilterAction').value;

            let filteredLog = activityLog;

            if (auditFilterAction) {
                filteredLog = filteredLog.filter(entry => entry.action === auditFilterAction);
            }

            if (auditSearchQuery) {
                filteredLog = filteredLog.filter(entry =>
                    entry.action.toLowerCase().includes(auditSearchQuery) ||
                    entry.details.toLowerCase().includes(auditSearchQuery) ||
                    new Date(entry.timestamp).toLocaleString().toLowerCase().includes(auditSearchQuery)
                );
            }
            
            if (filteredLog.length === 0) {
                auditTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary-light); padding: 20px;">No audit entries found matching your criteria.</td></tr>`;
                return;
            }

            auditTableBody.innerHTML = filteredLog.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td><span class="action-badge ${entry.action.split(' ')[0].toLowerCase()}">${entry.action}</span></td>
                    <td>${entry.details}</td>
                </tr>
            `).join('');
        }

        // --- Modal & Toast Functions ---
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            // Close modals when clicking outside, but not on the modal-content itself
            if (event.target.classList.contains('modal') && !event.target.closest('.modal-content')) {
                event.target.style.display = 'none';
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.querySelector('.toast-container') || (() => {
                const div = document.createElement('div');
                div.classList.add('toast-container');
                document.body.appendChild(div);
                return div;
            })();

            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.innerHTML = `<i class="fas ${getToastIcon(type)}"></i> ${message}`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-times-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-info-circle';
            }
        }

        function showConfirmation(message, onConfirm, onCancel = null) {
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmationModal').style.display = 'flex'; // Use flex for centering
            
            // Store callback in a global property (or use event listeners directly)
            window.currentConfirmCallback = (confirmed) => {
                if (confirmed) {
                    onConfirm();
                } else if (onCancel) {
                    onCancel();
                }
                window.currentConfirmCallback = null; // Clear callback
            };
        }

        // --- PDF Export Functions (Using jsPDF and html2canvas) ---
        async function generatePdfFromHtml(elementId, filename) {
            showLoading(`Preparing ${filename.replace('.pdf', '')} for export...`, 'Optimizing content for high-fidelity PDF rendering...');
            const element = document.getElementById(elementId);
            if (!element) {
                hideLoading();
                showToast(`Error: Element with ID '${elementId}' not found for PDF export.`, 'error');
                return;
            }

            // Temporarily clone and make the element visible off-screen for accurate rendering
            const clonedElement = element.cloneNode(true);
            clonedElement.style.position = 'absolute';
            clonedElement.style.left = '-9999px';
            clonedElement.style.width = '1200px'; // Give it a consistent, wide width for good layout
            clonedElement.style.background = 'white'; // Ensure white background for PDF output
            clonedElement.style.padding = '30px'; // Add padding to the cloned content
            clonedElement.style.color = '#333'; // Ensure dark text for light PDF background
            clonedElement.style.boxShadow = 'none'; // Remove shadows that might interfere with rendering
            clonedElement.style.transform = 'none'; // Remove transforms

            // Reset specific styles within the cloned element to ensure consistent rendering
            clonedElement.querySelectorAll('*').forEach(child => {
                // Remove dynamic properties that might interfere with static rendering
                child.style.transition = 'none';
                child.style.boxShadow = 'none';
                child.style.backgroundColor = ''; // Use default or explicitly set white
                child.style.color = '#333'; // Default text color
                if (child.classList.contains('status-badge')) { // Ensure badges render correctly
                    const status = Array.from(child.classList).find(cls => cls.startsWith('status-'));
                    if (status) {
                         // Apply original light mode badge colors explicitly for PDF
                        if (status === 'status-new') { child.style.backgroundColor = '#fff3cd'; child.style.color = '#856404'; }
                        else if (status === 'status-in-progress') { child.style.backgroundColor = '#d1ecf1'; child.style.color = '#0c5460'; }
                        else if (status === 'status-escalated') { child.style.backgroundColor = '#f8d7da'; child.style.color = '#721c24'; }
                        else if (status === 'status-resolved') { child.style.backgroundColor = '#d4edda'; child.style.color = '#155724'; }
                        else if (status === 'status-closed') { child.style.backgroundColor = '#e2e6ea'; child.style.color = '#383d41'; }
                    }
                }
                if (child.classList.contains('action-badge')) { // Ensure audit badges render correctly
                    const actionClass = Array.from(child.classList).find(cls => cls.startsWith('action-'));
                     if (actionClass) {
                        if (actionClass.includes('created')) { child.style.backgroundColor = '#d4edda'; child.style.color = '#155724'; }
                        else if (actionClass.includes('updated')) { child.style.backgroundColor = '#cce5ff'; child.style.color = '#004085'; }
                        else if (actionClass.includes('deleted')) { child.style.backgroundColor = '#f8d7da'; child.style.color = '#721c24'; }
                        else if (actionClass.includes('generated')) { child.style.backgroundColor = '#fff3cd'; child.style.color = '#856404'; }
                        else if (actionClass.includes('imported')) { child.style.backgroundColor = '#bee5eb'; child.style.color = '#005662'; }
                        else if (actionClass.includes('exported')) { child.style.backgroundColor = '#e0e9ed'; child.style.color = '#36454F'; }
                        else if (actionClass.includes('theme')) { child.style.backgroundColor = '#e3d2ff'; child.style.color = '#5a008c'; }
                    }
                }
            });


            document.body.appendChild(clonedElement); // Add to DOM for html2canvas to render

            try {
                const scale = 2; // For better quality
                const canvas = await html2canvas(clonedElement, { scale: scale, useCORS: true, logging: false }); // Disable logging for cleaner console
                const imgData = canvas.toDataURL('image/jpeg', 1.0); 

                const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size
                const imgWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) { // Fix: ensure loop runs as long as there's content left
                    position = -(imgHeight - heightLeft); // Calculate correct position for next page
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(filename);
                showToast('PDF generated successfully!', 'success');
            } catch (error) {
                console.error("Error generating PDF:", error);
                showToast('Failed to generate PDF. Please try again or check console for details.', 'error');
            } finally {
                clonedElement.remove(); // Clean up cloned element
                hideLoading();
            }
        }

        async function exportPlaybooks() {
            await simulateBackendOperation(
                'Generating Playbooks Report PDF...',
                async () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'tempPlaybookPdfContent';
                    tempDiv.innerHTML = generatePlaybookReportHtml(); 
                    document.body.appendChild(tempDiv); // Temporarily add to body for html2canvas
                    await generatePdfFromHtml('tempPlaybookPdfContent', 'SOC_Playbooks_Report.pdf');
                    tempDiv.remove(); // Clean up
                    activityLog.unshift({ action: "Report Generated", details: "Exported All Playbooks (PDF)", timestamp: new Date().toISOString() });
                    updateDashboard();
                    renderAuditTrail();
                },
                'Playbooks report generated successfully!',
                'Failed to generate playbooks report.'
            );
        }

        async function exportInstances() {
            await simulateBackendOperation(
                'Generating Active Incidents Report PDF...',
                async () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'tempInstancePdfContent';
                    tempDiv.innerHTML = generateInstanceReportHtml(); 
                    document.body.appendChild(tempDiv);
                    await generatePdfFromHtml('tempInstancePdfContent', 'SOC_Active_Incidents_Report.pdf');
                    tempDiv.remove();
                    activityLog.unshift({ action: "Report Generated", details: "Exported Active Incidents (PDF)", timestamp: new Date().toISOString() });
                    updateDashboard();
                    renderAuditTrail();
                },
                'Active incidents report generated successfully!',
                'Failed to generate active incidents report.'
            );
        }

        async function exportSummaryReport() {
            await simulateBackendOperation(
                'Generating Summary Report PDF...',
                async () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'tempSummaryPdfContent';
                    tempDiv.innerHTML = generateSummaryReportHtml(); 
                    document.body.appendChild(tempDiv);
                    await generatePdfFromHtml('tempSummaryPdfContent', 'SOC_Summary_Report.pdf');
                    tempDiv.remove();
                    activityLog.unshift({ action: "Report Generated", details: "Generated Summary Report (PDF)", timestamp: new Date().toISOString() });
                    updateDashboard();
                    renderAuditTrail();
                },
                'Summary report generated successfully!',
                'Failed to generate summary report.'
            );
        }

        async function exportInstanceReport(id) {
            const instance = instances.find(i => i.id === id);
            if (!instance) {
                showToast('Incident not found for report generation!', 'error');
                return;
            }

            await simulateBackendOperation(
                `Generating Incident Report for Incident ${instance.id}...`,
                async () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'tempSingleInstancePdfContent';
                    tempDiv.innerHTML = generateSingleInstanceReportHtml(instance);
                    document.body.appendChild(tempDiv);
                    await generatePdfFromHtml('tempSingleInstancePdfContent', `Incident_${instance.id}_Report.pdf`);
                    tempDiv.remove();
                    activityLog.unshift({ action: "Report Generated", details: `Exported Report for Incident ${instance.id} - ${instance.incidentTitle}`, timestamp: new Date().toISOString() });
                    updateDashboard();
                    renderAuditTrail();
                },
                `Incident report for ${instance.incidentTitle} generated successfully!`,
                `Failed to generate incident report for ${instance.incidentTitle}.`
            );
        }
        
        // These functions generate the raw HTML content *specifically for PDF*,
        // ensuring styles are inlined or simple for PDF rendering by html2canvas
        // Important: These are separate from the UI rendering functions as they need a simpler,
        // more controlled HTML structure for PDF capture.
        function generatePlaybookReportHtml() {
            let html = `
                <div style="font-family: 'Roboto', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #333; line-height: 1.6;">
                    <h1 style="color: #1e3c72; text-align: center; margin-bottom: 30px; font-size: 2.2em;">SOC Playbooks Report</h1>
                    <p style="text-align: center; color: #666; margin-bottom: 40px; font-size: 0.9em;">Generated on ${new Date().toLocaleString()}</p>
            `;
            
            playbooks.forEach(playbook => {
                html += `
                    <div style="margin-bottom: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
                        <h2 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.5em;">${playbook.title}</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 0.9em;">
                            <div><strong>Alert Type:</strong> ${playbook.alertType}</div>
                            <div><strong>Severity:</strong> ${playbook.severity}</div>
                            <div><strong>Created:</strong> ${new Date(playbook.created).toLocaleDateString()}</div>
                            <div><strong>Usage Count:</strong> ${playbook.usageCount || 0}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Description:</strong>
                            <p style="margin-top: 5px; color: #666;">${playbook.description}</p>
                        </div>
                        <div>
                            <strong>Steps:</strong>
                            <ol style="margin-top: 10px; padding-left: 20px;">
                                ${playbook.steps.map((step, i) => `<li style="margin-bottom: 5px; color: #333;">${i + 1}. ${step}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function generateInstanceReportHtml() {
            let html = `
                <div style="font-family: 'Roboto', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #333; line-height: 1.6;">
                    <h1 style="color: #1e3c72; text-align: center; margin-bottom: 30px; font-size: 2.2em;">Active Incidents Report</h1>
                    <p style="text-align: center; color: #666; margin-bottom: 40px; font-size: 0.9em;">Generated on ${new Date().toLocaleString()}</p>
            `;
            
            instances.filter(i => i.status !== 'closed').sort((a,b) => b.id - a.id).forEach(instance => { // Exclude closed for active report
                html += `
                    <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #ffffff;">
                        <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.3em;">${instance.incidentTitle}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.9em;">
                            <div><strong>Incident ID:</strong> ${instance.id}</div>
                            <div><strong>Status:</strong> <span style="font-weight: bold; color: ${getStatusColor(instance.status)};">${instance.status.replace('-', ' ').toUpperCase()}</span></div>
                            <div><strong>Playbook:</strong> ${instance.playbookTitle}</div>
                            <div><strong>Analyst:</strong> ${instance.assignedAnalyst}</div>
                            <div><strong>Priority:</strong> ${instance.priority}</div>
                            <div><strong>Affected Assets:</strong> ${instance.affectedAssets || 'N/A'}</div>
                            <div><strong>Created:</strong> ${new Date(instance.created).toLocaleString()}</div>
                            <div><strong>Last Updated:</strong> ${new Date(instance.updated).toLocaleString()}</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Initial Notes:</strong>
                            <p style="margin-top: 5px; color: #666;">${instance.notes}</p>
                        </div>
                        ${instance.progressNotes ? `
                            <div>
                                <strong>Progress Notes:</strong>
                                <p style="margin-top: 5px; color: #666;">${instance.progressNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function generateSummaryReportHtml() {
            const totalInstances = instances.length;
            const activeInstancesCount = instances.filter(i => i.status !== 'resolved' && i.status !== 'closed').length;
            const resolvedInstancesCount = instances.filter(i => i.status === 'resolved' || i.status === 'closed').length;
            const escalatedInstancesCount = instances.filter(i => i.status === 'escalated').length;
            
            let html = `
                <div style="font-family: 'Roboto', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #333; line-height: 1.6;">
                    <h1 style="color: #1e3c72; text-align: center; margin-bottom: 30px; font-size: 2.2em;">SOC Summary Report</h1>
                    <p style="text-align: center; color: #666; margin-bottom: 40px; font-size: 0.9em;">Generated on ${new Date().toLocaleString()}</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3 style="color: #1e3c72; font-size: 2rem; margin-bottom: 10px;">${playbooks.length}</h3>
                            <p style="color: #666;">Total Playbooks</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3 style="color: #1e3c72; font-size: 2rem; margin-bottom: 10px;">${totalInstances}</h3>
                            <p style="color: #666;">Total Incidents</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3 style="color: #1e3c72; font-size: 2rem; margin-bottom: 10px;">${activeInstancesCount}</h3>
                            <p style="color: #666;">Active Incidents</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <h3 style="color: #1e3c72; font-size: 2rem; margin-bottom: 10px;">${escalatedInstancesCount}</h3>
                            <p style="color: #666;">Escalated Cases</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.5em;">Recent Activity</h2>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        ${activityLog.slice(0, 10).map(activity => `
                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #2a5298;">
                                <strong>${activity.action}</strong><br>
                                <span style="color: #666;">${activity.details}</span><br>
                                <small style="color: #999;">${new Date(activity.timestamp).toLocaleString()}</small>
                            </div>
                        `).join('')}

                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generateSingleInstanceReportHtml(instance) {
            const playbook = playbooks.find(p => p.id === instance.playbookId);
            
            let html = `
                <div style="font-family: 'Roboto', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #333; line-height: 1.6;">
                    <h1 style="color: #1e3c72; text-align: center; margin-bottom: 30px; font-size: 2.2em;">Incident Report</h1>
                    <p style="text-align: center; color: #666; margin-bottom: 40px; font-size: 0.9em;">Generated on ${new Date().toLocaleString()}</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h2 style="color: #1e3c72; margin-bottom: 20px; font-size: 1.5em;">${instance.incidentTitle}</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; font-size: 0.9em;">
                            <div><strong>Incident ID:</strong> ${instance.id}</div>
                            <div><strong>Status:</strong> <span style="font-weight: bold; color: ${getStatusColor(instance.status)};">${instance.status.replace('-', ' ').toUpperCase()}</span></div>
                            <div><strong>Priority:</strong> ${instance.priority}</div>
                            <div><strong>Assigned Analyst:</strong> ${instance.assignedAnalyst}</div>
                            <div><strong>Affected Assets:</strong> ${instance.affectedAssets || 'N/A'}</div>
                            <div><strong>Created:</strong> ${new Date(instance.created).toLocaleString()}</div>
                            <div><strong>Last Updated:</strong> ${new Date(instance.updated).toLocaleString()}</div>
                            ${instance.resolvedAt ? `<div><strong>Resolved:</strong> ${new Date(instance.resolvedAt).toLocaleString()}</div>` : ''}
                            <div><strong>Playbook Used:</strong> ${instance.playbookTitle}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.2em;">Initial Assessment</h3>
                        <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #2a5298;">
                            <p style="color: #333;">${instance.notes}</p>
                        </div>
                    </div>
                    
                    ${instance.progressNotes ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.2em;">Progress Notes</h3>
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                                <p style="color: #333;">${instance.progressNotes}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${playbook ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.2em;">Playbook Steps (Reference)</h3>
                            <div style="background: white; padding: 15px; border-radius: 6px;">
                                <ol style="padding-left: 20px;">
                                    ${playbook.steps.map((step, i) => `<li style="margin-bottom: 8px; color: #333;">${i + 1}. ${step}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }

        // Helper to get status color for PDF rendering (inlined styles)
        function getStatusColor(status) {
            switch(status) {
                case 'new': return '#856404'; // Dark yellow
                case 'in-progress': return '#0c5460'; // Dark cyan
                case 'escalated': return '#721c24'; // Dark red
                case 'resolved': return '#155724'; // Dark green
                case 'closed': return '#383d41'; // Dark grey
                default: return '#333';
            }
        }

        // --- Data Import/Export (JSON) ---
        function exportToJSON() {
            simulateBackendOperation(
                'Preparing data for export...',
                () => new Promise(resolve => {
                    setTimeout(() => {
                        const data = {
                            playbooks: playbooks,
                            instances: instances,
                            activityLog: activityLog,
                            exportDate: new Date().toISOString(),
                            version: "1.0.0" 
                        };
                        
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `SOC_Backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`; // Unique filename
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        activityLog.unshift({ action: "Data Exported", details: "Application data exported to JSON", timestamp: new Date().toISOString() });
                        updateDashboard();
                        saveDataToLocalStorage();
                        renderAuditTrail();
                        resolve();
                    }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                }),
                "Data exported successfully! Check your downloads folder.",
                "Failed to export data."
            );
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) {
                showToast("No file selected for import.", 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    showConfirmation('This will REPLACE all current data with the imported data. Are you sure you want to proceed? This cannot be undone!', () => {
                        simulateBackendOperation(
                            'Importing data...',
                            () => new Promise(resolve => {
                                setTimeout(() => {
                                    playbooks = data.playbooks || [];
                                    instances = data.instances || [];
                                    activityLog = data.activityLog || [];

                                    // Re-sort activity log to ensure chronological order for display
                                    activityLog.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                                    
                                    updateDashboard();
                                    renderPlaybooks();
                                    renderInstances();
                                    updateInstancePlaybookOptions();
                                    
                                    activityLog.unshift({ action: "Data Imported", details: "Application data imported from JSON file", timestamp: new Date().toISOString() });
                                    updateDashboard();
                                    saveDataToLocalStorage();
                                    renderAuditTrail();
                                    resolve();
                                }, Math.random() * MAX_LOADING_TIME + MIN_LOADING_TIME);
                            }),
                            'Data imported successfully!',
                            'Error importing file: Invalid JSON format or file corrupted. Please ensure it is a valid backup file.'
                        );
                    }, () => {
                        showToast('Data import cancelled.', 'info');
                    });

                } catch (error) {
                    console.error("Import error:", error);
                    showToast('Error parsing file: Invalid JSON format. Please ensure it is a valid backup file.', 'error');
                } finally {
                    event.target.value = ''; // Clear the file input
                }
            };
            reader.readAsText(file);
        }

        // --- Utility Functions ---
        function initializeHelp() {
            const helpTexts = {
                'playbookTitle': 'Enter a descriptive title for your playbook (e.g., "Malware Detection Response")',
                'alertType': 'Select the type of security alert this playbook addresses',
                'severity': 'Choose the severity level to help prioritize incidents',
                'description': 'Provide a brief overview of the playbook purpose and scope, including prerequisites and target audience.',
                'incidentTitle': 'A concise title for the incident being tracked (e.g., Compromised account detected)',
                'affectedAssets': 'Comma-separated list of affected systems, accounts, or resources (e.g., WS-001, User_X, Server_Y)',
                'instancePlaybook': 'Select the pre-defined playbook to follow for this incident',
                'assignedAnalyst': 'The analyst responsible for handling this incident',
                'priority': 'The criticality of this incident, influencing response urgency',
                'incidentNotes': 'Initial observations, context, relevant alerts, and any raw data gathered at incident creation.',
                'progressNotes': 'Detailed notes about progress, findings, actions taken, and next steps during the incident lifecycle.'
            };
            
            Object.keys(helpTexts).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = helpTexts[id];
                }
            });
        }

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', function(e) {
            // Prevent default browser shortcuts for common actions
            if (e.ctrlKey || e.metaKey) { 
                switch(e.key.toLowerCase()) { 
                    case 'n': // New Playbook/Incident
                        e.preventDefault();
                        // Check which content section is active to open the correct modal
                        if (document.getElementById('playbooks').classList.contains('active')) {
                            simulateBackendOperation('Opening playbook creation...', showCreatePlaybookModal);
                        } else if (document.getElementById('instances').classList.contains('active')) {
                            simulateBackendOperation('Initializing new incident...', showCreateInstanceModal);
                        }
                        break;
                    case 'd': // Dashboard
                        e.preventDefault();
                        showSection('dashboard', document.querySelector('.nav-btn:nth-child(1)'));
                        break;
                    case 'p': // Playbooks
                        e.preventDefault();
                        showSection('playbooks', document.querySelector('.nav-btn:nth-child(2)'));
                        break;
                    case 'i': // Instances
                        e.preventDefault();
                        showSection('instances', document.querySelector('.nav-btn:nth-child(3)'));
                        break;
                    case 'r': // Reports
                        e.preventDefault();
                        showSection('reports', document.querySelector('.nav-btn:nth-child(4)'));
                        break;
                    case 'a': // Audit Trail
                        e.preventDefault();
                        showSection('auditTrail', document.querySelector('.nav-btn:nth-child(5)'));
                        break;
                    case 's': // Save (would be for forms, but for this app maybe export?)
                        // No general save, as forms auto-save on submit.
                        // Can add for exportToJSON if desired, e.g., Ctrl+Shift+S
                        // e.preventDefault(); 
                        // exportToJSON();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal').forEach(modal => {
                    if (window.getComputedStyle(modal).display !== 'none') {
                        closeModal(modal.id);
                        return; // Close only the top-most open modal
                    }
                });
            }
        });

        // Auto-refresh dashboard every 30 seconds
        setInterval(() => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                updateDashboard();
            }
        }, 30000);

        // Add step with Enter key
        document.getElementById('newStepInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addStep();
            }
        });

        console.log('Enterprise SOC Playbook & Incident Manager loaded successfully');
        console.log('Keyboard shortcuts: Ctrl/Cmd+N (new playbook/incident), Ctrl/Cmd+D (dashboard), Ctrl/Cmd+P (playbooks), Ctrl/Cmd+I (incidents), Ctrl/Cmd+R (reports), Ctrl/Cmd+A (audit), Esc (close modals)');
        
    </script>
    <footer class="app-footer">
        <p>&copy; 2025 Enterprise SOC Management. All Rights Reserved. | Version 1.0.0</p>
        <p>Powered by Advanced Threat Intelligence Platform. Securely managed. Compliance ready.</p>
    </footer>
</body>
</html>